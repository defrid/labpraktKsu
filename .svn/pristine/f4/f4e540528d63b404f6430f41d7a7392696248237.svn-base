var url = require('url');
var express = require('express');
var http = require('http');
var config = null;

module.exports = function(conf) {
    config = conf;
    var router = express.Router();
    createRoutes(router);
    return router;
};

function createRoutes(router) {
    var bodyParser = require('body-parser');

    router.use(bodyParser.json());

    router.get('/get', function(req, res) {
        getParserConfig(res);
    });

    router.post('/set', function(req, res) {
        setParserConfig(req, res);
    });
}

function getParserConfig(res) {
    if(config.getServiceEndpoint("connector-csv-service-rd") === undefined) {
        console.log("Cannot find endpoint for: connector-csv-service-rd");
        res.status(500);
        res.send('Endpoint is not configured!');
    } else {
        var parsedUrl = url.parse(config.getServiceEndpoint("connector-csv-service-rd").credentials.uri);
        var options = {
            hostname: parsedUrl.hostname,
            port: parsedUrl.port,
            path: config.get("parserPath"),
            method: 'GET',
            headers: {
                'Connection': 'close'
            }
        };

        console.log('options: ' + JSON.stringify(options));

        var req = http.request(options, function (r) {
            console.log(r.statusCode + ' ' + http.STATUS_CODES[r.statusCode]);
            console.log(JSON.stringify(r.headers));

            r.setEncoding('utf-8');
            r.pipe(res);
        });

        req.on('error', function (e) {
            console.log(JSON.stringify(e));
            res.send(e);
        });
    }

    req.end();
}

function setParserConfig(req, res) {
    if (req.body) {
        var data = JSON.stringify(req.body);
        var parsedUrl = url.parse(config.getServiceEndpoint("connector-csv-service-rd").credentials.uri);
        var options = {
            hostname: parsedUrl.hostname,
            port:     parsedUrl.port,
            path:     config.get("parserPath"),
            method:   'POST',
            headers:  {
                'Content-Length': data.length,
                'Connection': 'close',
                "Content-Type": "application/json"
            }
        };

        console.log('options: ' + JSON.stringify(options));

        var req = http.request(options, function(r) {
            console.log(r.statusCode + ' ' + http.STATUS_CODES[r.statusCode]);
            console.log(JSON.stringify(r.headers));
            r.pipe(res);
        });

        req.on('error', function(e) {
            console.log(JSON.stringify(e));
            res.send(e);
        });
        req.write(data);
        req.end();
    } else {
        res.status(500);
    }
}