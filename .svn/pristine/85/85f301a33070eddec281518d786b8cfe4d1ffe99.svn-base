var express = require('express');
var app = express();
var session = require('express-session')
var config = require('./config/platform-pivotal');

var user = require('./app/controllers/user');
var fileUpload = require('./app/controllers/file-upload');
var browse = require('./app/controllers/browse');
var logview = require('./app/controllers/logview');
var auditview = require('./app/controllers/auditview');
var parsercfg = require('./app/controllers/parsercfg');
var trace = require('./app/controllers/trace');

app.set('view engine', 'jade');

// Routes
app.use('/files', fileUpload(config));
app.use('/logview', logview(config));
app.use('/auditview', auditview(config));
app.use('/browse', browse(config));
app.use('/parsercfg', parsercfg(config));
app.use('/trace', trace({
  config: config,
  users: user.users

  // where to store/retrieve trace files (will become obsolete when REST API
  // will be realized;
  // tracePath: __dirname + '/traces',

  // template file used to generate WTF initializing script;
  // templateFile: __dirname + '/public/js/wtf/wtf_init.template'
}));

app.use(session({
  secret: 'keyboard cat',
  resave: false,
  saveUninitialized: true
}));

app.use(express.static(__dirname + '/public'));

var bodyParser = require('body-parser')
app.use( bodyParser.json() );       // to support JSON-encoded bodies
app.use(bodyParser.urlencoded({     // to support URL-encoded bodies
  extended: true
}));

function current_user(req){
  if (req.session.user_login){
    return {
      login: "demo"
    }
  }
  return null;
}

app.get('/api/session', function (req, res) {
  var user = current_user(req);
  if (!user) {
    res.status(401);
    res.send();
  } else {
    res.send(JSON.stringify({
      login: user.login
    }));
  }
});

app.post('/api/session', function (req, res) {
  if (req.body.login === 'demo' && req.body.password === 'kinetic'){

    req.session.user_login = 'demo';
    res.send(JSON.stringify({
      success: true,
      user: {
        login: req.session.user_login
      }
    }));
  } else {
    res.status(401);
    res.send(
        JSON.stringify({
          success: false,
          errors: ["Login or password incorrect"]
        })
        )
  };
});

function destroySession(req, res){
  req.session.user_login = null;
  res.send(JSON.stringify({ success: true }));
};

app.get('/api/session/destroy', destroySession);
app.delete('/api/session', destroySession);

app.get(['/'], function (req, res) {
  res.sendfile(__dirname + '/public/index.html');
});

app.get('/templ/config/*', function(req, res) {
  res.render('config/' + req.params[0], function(err, html) {
    if(err) {
      console.log("Error rendering config '" + req.params.path + "'\n", err);
      //res.status(404).end;
      res.send("No view "+ req.params.path +" found!\<br\>It has not been implemented.");
      //res.send(404);
    } else {
      res.send(html);
    }
  });

  //, function(err, html){  return html;//"cannot render "+ req.params.name;}
});

server = app.listen(parseInt(config.get("appPort")), function() {
  console.log('Listening on port %d', server.address().port);
});